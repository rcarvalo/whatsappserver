#!/usr/bin/env python3
"""
ü§ñ D√©monstration de l'Extracteur LLM de Montres
Exemples d'utilisation et cas d'usage avanc√©s
"""

import os
import sys
import json
from datetime import datetime
from dotenv import load_dotenv

# Charger les variables d'environnement
load_dotenv()

# Ajouter le dossier src au path
sys.path.append(os.path.join(os.path.dirname(__file__), 'src'))

def demo_basic_extraction():
    """D√©monstration de l'extraction basique"""
    
    print("ü§ñ D√âMONSTRATION - Extracteur LLM Basique")
    print("=" * 50)
    
    try:
        from src.llm_watch_extractor import LLMWatchExtractor
        
        # Initialiser l'extracteur
        extractor = LLMWatchExtractor(openai_api_key=os.getenv('OPENAI_API_KEY'))
        
        # Messages d'exemple
        messages = [
            "Je vends ma Rolex Submariner Date 116610LN, √©tat neuf avec bo√Æte et papiers. Prix: 9500‚Ç¨",
            "Cherche Omega Speedmaster Professional Moonwatch, budget max 4000‚Ç¨",
            "Quelqu'un conna√Æt la cote d'une Patek Philippe Nautilus ?",
            "URGENT! Daytona Panda 116500LN disponible, 28k‚Ç¨ n√©gociable",
            "Ma collection se s√©pare: PP 5711, AP 15400, Rolex Hulk - Prix sur demande"
        ]
        
        for i, message in enumerate(messages, 1):
            print(f"\nüì± MESSAGE {i}: {message}")
            
            # Extraction
            result = extractor.extract_watch_info(message)
            
            print(f"ü§ñ EXTRACTION:")
            print(f"   Marque: {result.brand}")
            print(f"   Mod√®le: {result.model}")
            print(f"   Prix: {result.price} {result.currency}")
            print(f"   Type: {result.message_type}")
            print(f"   Confiance: {result.confidence_score:.2f}")
            
            if result.llm_reasoning:
                print(f"   Raisonnement: {result.llm_reasoning[:80]}...")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
        return False

def demo_advanced_extraction():
    """D√©monstration avec m√©tadonn√©es WhatsApp"""
    
    print("\nüéØ D√âMONSTRATION - Extraction avec Contexte WhatsApp")
    print("=" * 55)
    
    try:
        from src.llm_watch_extractor import LLMWatchExtractor
        
        extractor = LLMWatchExtractor(openai_api_key=os.getenv('OPENAI_API_KEY'))
        
        # Message avec contexte
        message = "Les gars, ma Hulk est dispo si √ßa int√©resse quelqu'un. √âtat impec, full set. 12.5k"
        
        # M√©tadonn√©es WhatsApp enrichies
        metadata = {
            'sender_profile_name': 'Groupe Rolex Passion France',
            'sender_formatted_name': 'Pierre M.',
            'is_group_message': True,
            'group_context_indicators': ['groupe', 'passion'],
            'semantic_metadata': {
                'intent_signals': {
                    'is_selling': True,
                    'is_greeting': True,
                    'has_urgency': False
                },
                'text_analysis': {
                    'language_hints': ['french'],
                    'has_price': True,
                    'word_count': len(message.split())
                },
                'timing': {
                    'is_business_hours': True
                }
            }
        }
        
        print(f"üì± MESSAGE: {message}")
        print(f"üè¢ CONTEXTE: Groupe '{metadata['sender_profile_name']}'")
        
        # Extraction avec contexte
        result = extractor.extract_watch_info(message, metadata)
        
        print(f"\nü§ñ EXTRACTION ENRICHIE:")
        print(f"   Marque: {result.brand}")
        print(f"   Mod√®le: {result.model}")
        print(f"   Collection: {result.collection}")
        print(f"   Prix: {result.price} {result.currency}")
        print(f"   Type de prix: {result.price_type}")
        print(f"   Condition: {result.condition}")
        print(f"   Bo√Æte: {'Oui' if result.has_box else 'Non' if result.has_box is False else 'Non mentionn√©'}")
        print(f"   Papiers: {'Oui' if result.has_papers else 'Non' if result.has_papers is False else 'Non mentionn√©'}")
        print(f"   Type message: {result.message_type}")
        print(f"   N√©gociable: {'Oui' if result.negotiable else 'Non' if result.negotiable is False else 'Non pr√©cis√©'}")
        print(f"   Confiance: {result.confidence_score:.2f}")
        
        print(f"\nüß† RAISONNEMENT LLM:")
        print(f"   {result.llm_reasoning}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
        return False

def demo_batch_extraction():
    """D√©monstration d'extraction par lots"""
    
    print("\n‚ö° D√âMONSTRATION - Extraction par Lots")
    print("=" * 45)
    
    try:
        from src.llm_watch_extractor import LLMWatchExtractor
        
        extractor = LLMWatchExtractor(openai_api_key=os.getenv('OPENAI_API_KEY'))
        
        # Messages multiples
        batch_messages = [
            {
                'content': 'Vends Rolex GMT Master II 126710BLRO, √©tat neuf, 14000‚Ç¨',
                'metadata': {'sender_profile_name': 'Jean Dupont'}
            },
            {
                'content': 'Omega Seamaster Planet Ocean 600m, orange, 3500‚Ç¨',
                'metadata': {'sender_profile_name': 'Marc L.'}
            },
            {
                'content': 'ISO: Patek Philippe Aquanaut, budget flexible',
                'metadata': {'sender_profile_name': 'Collectionneur_Paris'}
            }
        ]
        
        print(f"üì¶ Traitement de {len(batch_messages)} messages...")
        
        # Extraction par lot
        results = extractor.extract_batch(batch_messages)
        
        for i, (message, result) in enumerate(zip(batch_messages, results), 1):
            print(f"\nüì± MESSAGE {i}: {message['content'][:50]}...")
            print(f"   Marque: {result.brand}")
            print(f"   Mod√®le: {result.model}")
            print(f"   Prix: {result.price}")
            print(f"   Type: {result.message_type}")
            print(f"   Confiance: {result.confidence_score:.2f}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
        return False

def demo_statistics_and_cache():
    """D√©monstration des statistiques et du cache"""
    
    print("\nüìä D√âMONSTRATION - Statistiques et Cache")
    print("=" * 45)
    
    try:
        from src.llm_watch_extractor import LLMWatchExtractor
        
        extractor = LLMWatchExtractor(openai_api_key=os.getenv('OPENAI_API_KEY'))
        
        # Plusieurs extractions pour g√©n√©rer des stats
        test_messages = [
            "Rolex Daytona acier, 25000‚Ç¨",
            "Omega Speedmaster, parfait √©tat, 4000‚Ç¨",
            "Cherche Patek Philippe Nautilus",
            "Tudor Black Bay, quasi neuve, 2800‚Ç¨"
        ]
        
        print("‚ö° Extraction de messages pour statistiques...")
        
        for message in test_messages:
            extractor.extract_watch_info(message)
        
        # Test du cache (m√™me message)
        print(f"\nüîÑ Test du cache...")
        start_time = datetime.now()
        extractor.extract_watch_info(test_messages[0])  # D√©j√† en cache
        cache_time = (datetime.now() - start_time).total_seconds()
        print(f"   Temps avec cache: {cache_time:.3f}s")
        
        # Statistiques
        stats = extractor.get_extraction_stats()
        print(f"\nüìà STATISTIQUES D'EXTRACTION:")
        print(json.dumps(stats, indent=2, ensure_ascii=False))
        
        # Nettoyage du cache
        extractor.clear_cache()
        print(f"\nüßπ Cache vid√©")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
        return False

def demo_complex_scenarios():
    """Sc√©narios complexes pour tester les limites"""
    
    print("\nüé≠ D√âMONSTRATION - Sc√©narios Complexes")
    print("=" * 45)
    
    try:
        from src.llm_watch_extractor import LLMWatchExtractor
        
        extractor = LLMWatchExtractor(openai_api_key=os.getenv('OPENAI_API_KEY'))
        
        complex_scenarios = [
            {
                'name': 'Message avec fautes',
                'content': 'salu jvend ma rolex submariner hulk etat impecable boite papier 12500e negociable'
            },
            {
                'name': 'Multiples montres',
                'content': 'Je vends ma collection: Rolex Sub (8k‚Ç¨), Omega Speedmaster (4k‚Ç¨), Tudor BB58 (3k‚Ç¨)'
            },
            {
                'name': 'Jargon technique',
                'content': 'Daytona 116500LN Panda, movement 4130, ceramic bezel, COSC certified, AD purchased'
            },
            {
                'name': 'Message √©motionnel',
                'content': 'üò¢ Je dois me s√©parer de ma Nautilus 5711/1A bleue... Prix de march√© actuel 150k‚Ç¨ mais je cherche collectionneur s√©rieux'
            }
        ]
        
        for scenario in complex_scenarios:
            print(f"\nüéØ {scenario['name'].upper()}:")
            print(f"   Message: {scenario['content']}")
            
            result = extractor.extract_watch_info(scenario['content'])
            
            print(f"   ü§ñ R√©sultat:")
            print(f"      Marque: {result.brand}")
            print(f"      Mod√®le: {result.model}")
            print(f"      Prix: {result.price}")
            print(f"      Type: {result.message_type}")
            print(f"      Confiance: {result.confidence_score:.2f}")
            
            if result.confidence_score > 0.7:
                print(f"      ‚úÖ Extraction de haute qualit√©")
            elif result.confidence_score > 0.4:
                print(f"      ‚ö†Ô∏è Extraction acceptable")
            else:
                print(f"      ‚ùå Extraction incertaine")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
        return False

def main():
    """Fonction principale de d√©monstration"""
    
    print("ü§ñ SUITE COMPL√àTE DE D√âMONSTRATIONS - Extracteur LLM")
    print("=" * 65)
    print("Cette d√©mo montre toutes les capacit√©s de l'extracteur LLM")
    print("pour l'analyse pr√©cise des messages de vente de montres")
    print("=" * 65)
    
    success = True
    
    # V√©rifier la cl√© API
    if not os.getenv('OPENAI_API_KEY'):
        print("‚ùå OPENAI_API_KEY non configur√©e")
        print("Configurer la variable d'environnement pour ex√©cuter cette d√©mo")
        return False
    
    # D√©monstrations
    demos = [
        ("Extraction basique", demo_basic_extraction),
        ("Extraction avec contexte", demo_advanced_extraction),
        ("Extraction par lots", demo_batch_extraction),
        ("Statistiques et cache", demo_statistics_and_cache),
        ("Sc√©narios complexes", demo_complex_scenarios)
    ]
    
    for demo_name, demo_func in demos:
        print(f"\nüé¨ Lancement: {demo_name}")
        if not demo_func():
            print(f"‚ùå √âchec de la d√©mo: {demo_name}")
            success = False
        else:
            print(f"‚úÖ Succ√®s de la d√©mo: {demo_name}")
    
    print("\n" + "=" * 65)
    if success:
        print("üéâ TOUTES LES D√âMONSTRATIONS R√âUSSIES!")
        print("\nüí° AVANTAGES DE L'EXTRACTEUR LLM:")
        print("   üéØ Pr√©cision sup√©rieure aux regex")
        print("   üß† Compr√©hension du contexte et des nuances")
        print("   üåç Gestion des fautes d'orthographe et du jargon")
        print("   üìä Classification automatique des intentions")
        print("   üîç Extraction d'informations complexes")
        print("   ‚ö° Cache intelligent pour optimiser les performances")
        print("   üìà Statistiques et monitoring int√©gr√©s")
        print("\nüöÄ Votre syst√®me WhatsApp RAG est pr√™t pour la production!")
    else:
        print("‚ùå CERTAINES D√âMONSTRATIONS ONT √âCHOU√â")
        print("V√©rifier la configuration des API keys")
    
    print("=" * 65)

if __name__ == "__main__":
    main()
